// This isyourPrismaschemafile,
//learnmoreaboutitinthedocs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User main model
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(CLIENT)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  client     Client?
  technician Technician?

  @@map("users")
}

// Client profile model
model Client {
  id                   String       @id @default(cuid())
  userId               String       @unique @map("user_id")
  companyName          String?      @map("company_name")
  contactPerson        String?      @map("contact_person")
  businessRegistration String?      @map("business_registration") // RUC for companies, DNI for personal
  phone                String?
  email                String? // Direct contact email for client
  emergencyContact     String?      @map("emergency_contact")
  address              String?
  city                 String?
  district             String? // <-- AÑADE ESTA LÍNEA
  postalCode           String?      @map("postal_code")
  clientType           ClientType   @default(PERSONAL) @map("client_type")
  sector               String?
  status               ClientStatus @default(ACTIVE)
  preferredSchedule    String?      @map("preferred_schedule") // "morning", "afternoon", "evening"
  nextServiceDate      DateTime?    @map("next_service_date")
  totalServices        Int          @default(0) @map("total_services")
  notes                String? // Additional notes about the client
  isVip                Boolean      @default(false) @map("is_vip")
  discount             Float?       @default(0.0) // Discount percentage for VIP clients
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relaciones con otras entidades
  services  Service[]
  quotes    Quote[]
  equipment Equipment[]

  @@map("clients")
}

// Technician profile model
model Technician {
  id                String   @id @default(cuid())
  userId            String   @unique @map("user_id")
  specialty         String
  experienceYears   Int      @map("experience_years")
  rating            Float
  phone             String?
  isAvailable       Boolean  @default(true) @map("is_available")
  servicesCompleted Int      @default(0) @map("services_completed")
  averageTime       String?  @map("average_time")
  firstName         String?  @map("first_name")
  lastName          String?  @map("last_name")
  name              String? // Nombre completo o combinado
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relaciones
  services Service[]

  @@map("technicians")
}

// Enums
enum UserRole {
  ADMIN
  TECHNICIAN
  CLIENT
}

enum ClientType {
  PERSONAL
  COMPANY
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BLOCKED
}

// Service model
model Service {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  clientId           String          @map("client_id")
  technicianId       String?         @map("technician_id")
  status             ServiceStatus   @default(PENDING)
  type               ServiceType
  priority           ServicePriority @default(MEDIUM)
  scheduledDate      DateTime        @map("scheduled_date")
  estimatedDuration  Int?            @map("estimated_duration") // minutes
  actualDuration     Int?            @map("actual_duration") // minutes
  equipmentIds       String[]        @map("equipment_ids") // Array of equipment IDs
  address            String
  contactPhone       String          @map("contact_phone")
  emergencyContact   String?         @map("emergency_contact")
  accessInstructions String?         @map("access_instructions")
  clientNotes        String?         @map("client_notes")

  // Completion fields
  workPerformed   String?  @map("work_performed")
  timeSpent       Int?     @map("time_spent") // minutes
  materialsUsed   Json?    @map("materials_used") // JSON array of materials
  technicianNotes String?  @map("technician_notes")
  clientSignature String?  @map("client_signature") // base64 image
  images          String[] // Array of image URLs

  // Timestamps
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relaciones
  client     Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  technician Technician? @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  quotes     Quote[]

  @@map("services")
}

// Equipment model (for future use)
model Equipment {
  id             String          @id @default(cuid())
  clientId       String          @map("client_id")
  name           String
  model          String?
  brand          String?
  serialNumber   String?         @map("serial_number")
  type           String // Refrigerador, Congelador, etc.
  location       String?
  installDate    DateTime?       @map("install_date")
  warrantyExpiry DateTime?       @map("warranty_expiry")
  status         EquipmentStatus @default(ACTIVE)
  notes          String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relaciones
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("equipment")
}

// Quote model (for future use)
model Quote {
  id          String      @id @default(cuid())
  serviceId   String?     @map("service_id")
  clientId    String      @map("client_id")
  title       String
  description String?
  amount      Float
  status      QuoteStatus @default(PENDING)
  validUntil  DateTime    @map("valid_until")
  approvedAt  DateTime?   @map("approved_at")
  rejectedAt  DateTime?   @map("rejected_at")
  notes       String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relaciones
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("quotes")
}

// Service-related enums
enum ServiceStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum ServiceType {
  MAINTENANCE
  REPAIR
  INSTALLATION
  INSPECTION
  EMERGENCY
  CLEANING
  CONSULTATION
}

enum ServicePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum EquipmentStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  BROKEN
}

enum QuoteStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}
